
TokenPod+ | Backend Infrastructure Guide (v16.9 Modular)
======================================================

This document outlines the architecture, deployment, and security protocols for the sharded Google Apps Script (GAS) backend.

1. ARCHITECTURE OVERVIEW
------------------------
The backend is split into 7 logical modules to ensure high performance, maintainability, and clear separation of concerns.

- Main.gs: Entry point (doPost), global router, and gatekeeping logic.
- Security.gs: HMAC SHA-256 signature verification and secret management.
- Database.gs: 20-segment sharding engine and trending project aggregation.
- Core.gs: Primary user vault lifecycle (Sync, Fetch, Onboarding).
- Economy.gs: Points engine, claim verification (0P policy), and protocol redemptions.
- Admin.gs: Administrative Command Center and activity analysis tools.
- Notifications.gs: Web Push protocol and scheduled signal processing.

2. IMPLEMENTATION STEPS (MANDATORY)
-----------------------------------
To deploy this backend in the Google Apps Script editor:

Step 1: Create 7 separate script files in your GAS project with the exact names listed above.
Step 2: Copy the corresponding logic from the codebase into each file.
Step 3: Delete any existing "backend.gs" or "Code.gs" files to prevent function name collisions.
Step 4: Click [Deploy] > [New Deployment] > [Web App].
Step 5: Set [Execute as: Me] and [Who has access: Anyone].
Step 6: Copy the generated Web App URL and update the client-side MASTER_UPLINK constant.

3. SECURITY PROTOCOLS
---------------------
- HMAC Signing: Every non-public request must be signed with HMAC SHA-256 using the user's hashedPin or admin sessionToken.
- Salt Management: A persistent "shardSalt" is generated on the first run to randomize user placement across the 20 segments.
- Interaction Lock: The system utilizes a 60-second database lock during updates to prevent write-collisions.
- Public Signal: The constant 'tp-public-signal-v1' is used exclusively for FEEDBACK actions.
- Logic Injection Defense: The `handlePush` handler explicitly filters sensitive keys (`points`, `rank`, `isAdmin`, etc.) during updates. Client-sent values for these keys are discarded in favor of existing database state.

4. ECONOMY POLICY (v6.9)
----------------------------------
- CLAIM_POD: This action is now point-free (0P). It strictly manages timer math and streak increments.
- POINTS: Points are exclusively granted via DAILY_BONUS, IGNITE_SPARK, and REDEEM_PROTOCOL.
- FOCUS_BONUS: This endpoint is decommissioned to ensure point integrity across sessions.

5. ADMIN COMMANDS
-----------------
The backend exposes restricted actions accessible only via the Admin Token:
- ADMIN_TRENDING_UPDATE: Forces a full scan of all 20 segments to tally app popularity.
- ADMIN_SEASONAL_RESET: Triggers the 10% point decay protocol system-wide.
- ADMIN_EXPORT_GLOBAL_LEDGER: Compiles a system snapshot of the entire sharded network.

======================================================
Official Backend Guide v16.9 | TokenPod+ | Verified Systems.